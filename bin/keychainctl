#!/usr/bin/env bash
#
# keychainctl lets you add/remove/list passwords in your keychain from the
# command line so you can use them more easily in scripts
#
# Copyright 2020-2025 Joe Block <jpb@unixorn.net>
#
# Original source: https://gist.github.com/AriaFallah/fe7b651ba2652bd301334e011749e4b2/

SERVICE=${SERVICE:-"cli-secret"}

function debug() {
  if [[ -n "$DEBUG" ]]; then
      echo-stderr "$@"
  fi
}

function echo-stderr() {
  printf '%s\n' "$1" >&2  ## Send message to stderr. Exclude >&2 if you don't want it that way.
}

function fail() {
  echo-stderr "$1"
  exit "${2-1}"  ## Return a code specified by $2 or 1 by default.
}

function check-dependency() {
  if ! (builtin command -V "$1" >/dev/null 2>&1); then
    fail "Missing dependency: can't find $1 in your PATH"
  fi
}

function only-run-on() {
  # shellcheck disable=SC2086
  if [[ "$(uname -s | tr '[:upper:]' '[:lower:]')" != "$(echo $1 | tr '[:upper:]' '[:lower:]')" ]]; then
    fail "This script only runs on $1, this machine is running $(uname -s)"
  else
    debug "OS ($(uname -s)) is valid..."
  fi
}

function list-secrets() {
  security dump-keychain | grep 0x00000007 | awk -F= '{print $2}' | tr -d \"
}

function get-secret() {
  if [[ -z "$1" ]]; then
    print-usage
  fi
  secret=$(security find-generic-password -ga "$1" 2>&1 | \
    awk '/password/ {print $NF}' | sed 's/"//g')
  found=$(echo -n "$secret" | awk '{print NR}')
  if [[ "$found" != 1 ]];then
    fail "Did not find $1 in keychain"
  fi
  echo "$secret"
}

function set-secret() {
  if [[ -z "$1" ]]; then
    print-usage
  fi
  security add-generic-password -s "$1" -a "$1" -w
}

function delete-secret() {
  if [[ -z "$1" ]]; then
    print-usage
  fi
  security delete-generic-password -a "$1" -s "$1"
}

function print-usage() {
  NAME=$(basename "$0")
  cat << EOF
Usage:
  $NAME set <name>
  $NAME get <name>
  $NAME rm <name>
  $NAME ls
  $NAME lock|lock-keychain
EOF
  exit 0
}

main () {
  if [[ -z "$1" ]]; then
    print-usage
  fi

  case "$1" in
    ls) list-secrets ;;
    lock|lock-keychain) exec security lock-keychain;;
    get) get-secret "$2" ;;
    set) set-secret "$2" "$3" ;;
    rm) delete-secret "$2" ;;
    *) print-usage ;;
  esac
}

only-run-on darwin
check-dependency security

# shellcheck disable=SC2068
main $@
